<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>WristGrab Player</title>
	<link href="style.css" rel="stylesheet" media="screen">
</head>
<body>
	<div class="navbar navbar-fixed-top">
		<div class="navbar-inner">
			<div class="container">
				<a class="brand" href="/">WristGrab</a>
				<ul class="nav">
					<li><a href="#">Browse Rooms <i class="icon-th-large"></i></a></li>
					<li><a href="#">Create Room <i class="icon-star"></i></a></li>
				</ul>
				<ul class="nav pull-right noscript-hide">
					<li id="login-dropdown" class="dropdown logged-out">
						<a class="dropdown-toggle" href="#" data-toggle="dropdown">Log In <i class="icon-share-alt"></i></a>
						<div class="dropdown-menu" style="padding: 15px;">
							<form method="post" action="/login">
								<input type="text" name="username" placeholder="Username or e-mail"></input>
								<input type="password" name="password" placeholder="Password"></input>
								<button type="submit" class="btn btn-block" data-loading-text="logging in..." autocomplete="off">Log in</button>
								<div class="text-error text-center" style="display: none;">Login failed!</div>
							</form>
						</div>
					</li>
					<li class="logged-out"><a href="#register" role="button" data-toggle="modal">Register <i class="icon-edit"></i></a></li>
					<li class="logged-in"><a href="#">Settings <i class="icon-cog"></i></a></li>
					<li class="logged-in"><a id="logout" href="#">Log Out <i class="icon-arrow-left"></i></a></li>
				</ul>
			</div>
		</div>
	</div>

	<div id="register" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="registerLabel" aria-hidden="true">
		<div class="modal-header">
			<h3 id="registerLabel">Register</h3>
		</div>
		<div class="modal-body">
			<form class="form-horizontal" method="post" action="/register">
				<div class="control-group">
					<label class="control-label" for="inputUsername">Username</label>
					<div class="controls">
						<input type="text" id="inputUsername" placeholder="Username">
					</div>
				</div>
				<div class="control-group">
					<label class="control-label" for="inputEmail">Email</label>
					<div class="controls">
						<input type="text" id="inputEmail" placeholder="Email">
					</div>
				</div>
				<div class="control-group">
					<label class="control-label" for="inputPassword">Password</label>
					<div class="controls">
						<input type="password" id="inputPassword" placeholder="Password">
					</div>
				</div>
				<div class="form-actions">
					<button class="btn btn-primary" type="submit" data-loading-text="registering..." autocomplete="off">Register</button>
					<button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
				</div>
			</form>
		</div>
	</div>

	<noscript>
		<div class="container">
			<div class="hero-unit">
				<h2>Javascript is required for this site.</h2>
				<p>It looks like your browser doesn't support Javascript, or it's been disabled. This site requires Javascript in order to synchronize video playback. <a href="http://activatejavascript.org/">Enable Javascript</a> or <a href="http://browsehappy.com/">upgrade your web browser</a> and come back to enjoy simultaneous viewing!</p>
			</div>
		</div>
	</noscript>

	<div class="container noscript-hide">
		<div class="jumbotron text-center">
			<p class="lead">Watch videos together, no matter where you are. Add something to the playlist to get started.</p>
		</div>
		<div class="row-fluid">
			<div class="span8">
				<div class="text-center">
					<div id="player"></div>
				</div>
				<div>
					<button id="nickname" type="button" class="btn">Change Nickname</button>
				</div>
			</div>
			<div class="span4">
				<div id="table-scroll">
					<table class="table table-striped table-condensed" id="playlist">
						<tbody></tbody>
					</table>
				</div>
				<div id="playlistControls">
					    <a class="btn btn-mini" id="add"><i class="icon-plus"></i></a>
				</div>
			</div>
		</div>
		<div class="row-fluid">
			<div class="span8">
				<div class="well">
					<ul id="chatbox" class="unstyled">
					</ul>
				</div>
				<form id="chatform" class="form-inline">
					<div class="input-append input-block-level" style="display: block;">
						<input id="chatinput" class="input-block-level" type="text" placeholder="Type a chat message..." autocomplete="off">
						<button id="chatbutton" class="btn" type="submit">Send <i class="icon-comment icon-white"></i></button>
					</div>
				</form>
			</div>
			<div class="span4">
				<div class="well">
					<ul id="chatlist" class="unstyled">
					</ul>
				</div>
			</div>
		</div>
	</div>

	<script src="http://code.jquery.com/jquery.js"></script>
	<script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script src="http://malsup.github.com/jquery.form.js"></script>
	<script>
		$('.noscript-hide').removeClass('noscript-hide');

		var socket = io.connect();

		var tag = document.createElement('script');

		tag.src = 'https://www.youtube.com/iframe_api';
		var firstScriptTag = document.getElementsByTagName('script')[0];
		firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

		var width = $('#player').width();

		var player;
		function onYouTubeIframeAPIReady() {
			player = new YT.Player('player', {
				height: width * (9 / 16),
				width: width,
				videoId: 'U7mPqycQ0tQ',
				events: {
					'onReady': onPlayerReady,
					'onStateChange': onPlayerStateChange
				}
			});
		}

		function onPlayerReady(event) {
			player.getVideoId = function() { return player.j.videoData.video_id; }

			socket.on('pause', function(data) {
				if (data.videoId !== player.getVideoId()) {
					player.loadVideoById(data.videoId, data.timestamp);
				}
				player.seekTo(data.timestamp, true);
				player.pauseVideo();
			});

			socket.on('play', function(data) {
				if (data.videoId !== player.getVideoId()) {
					player.loadVideoById(data.videoId, data.timestamp);
				}
				if (canSeekTo(data.timestamp)) {
					player.seekTo(data.timestamp, true);
				}
				player.playVideo();
			});

			socket.on('requestUpdate', function() {
				sendUpdate();
			});

			sendUpdate();
		}

		function onPlayerStateChange(event) {
			sendUpdate();

			if (event.data == YT.PlayerState.ENDED) {
				var current = $('#playlist tr.playing');
				var next = current.is(':last-child') ? $('#playlist tr:first') : current.next();
				playEntry(next);
			}
		}

		function sendUpdate() {
			socket.emit('update', { 
				status : player.getPlayerState(),
				time : player.getCurrentTime(), 
				videoId : player.getVideoId(),
				loaded : player.getVideoLoadedFraction() 
			});
		}

		function canSeekTo(timestamp) {
			return Math.abs(player.getCurrentTime() - timestamp) >= 1;
		}

		function playEntry(next) {
			$('#playlist tr.playing').removeClass('playing');
			next.addClass('playing');
			updatePlayList();
			player.loadVideoById(next.attr('data-id'));
		}

		function updatePlayList() {
			var list = $('#playlist tr').map(function() { return $(this).attr('data-id'); }).get();
			socket.emit('updatePlayList', list, $('#playlist tr.playing').index());
		}

		function addToPlayList(id){
			$('#playlist tbody').append('<tr data-id="'+id+'"><td>Loading...</td><td>Loading...</td><td><button class="close">&times;</button></td></tr>');

			$.ajax({
				url: "http://gdata.youtube.com/feeds/api/videos/"+id+"?v=2&alt=json",
				dataType: "jsonp",
				success: function (data) {
					$('#playlist tr[data-id='+id+'] td:nth-child(1)').text(data.entry.title.$t);
					$('#playlist tr[data-id='+id+'] td:nth-child(2)').text(data.entry.media$group.yt$duration.seconds);
				}
			});
		}

		$(document).ready(function() {
			$("#playlist").sortable({
				containment: 'parent',
				distance: 10,
				items: 'tr',
				scroll: true,
				tolerance: 'pointer',
				update: function(event, ui) {
					updatePlayList();
				},
			});
		});

		$('#add').click(function () {
			var id = prompt('Enter a YouTube video ID:');
			if (id) {
				addToPlayList(id);
				updatePlayList();
			}
		});

		$('#chatform').submit(function() {
			var input = $('#chatinput');
			socket.emit('chat', { text: input.val() });
			input.val('');
			return false;
		});

		var updateChatButton = function(event) {
			if ($('#chatinput').val() == '') {
				$('#chatbutton').attr('disabled', 'disabled');
			} else {
				$('#chatbutton').removeAttr('disabled');
			}
		};

		updateChatButton();

		$('#chatinput').keyup(updateChatButton).keydown(updateChatButton).change(updateChatButton);

		socket.on('chat', function(data) {
			var div = $('#chatbox');
			div.append($('<li>').append($('<strong>').text(data.name + ': ')).append($('<span>').text(data.text)));
			div.animate({ scrollTop: div.prop('scrollHeight') - div.height() }, 1);
		});

		socket.on('list', function(list) {
			$('#chatlist').empty();
			$.each(list, function(index, item) {
				var div = $('#chatlist');
				div.append($('<li>').append($('<strong>').text(item)));
			});
		});

		socket.on('refreshPlayList', function(list, index) {
			$('#playlist tbody').empty();

			list.forEach(function(item) { addToPlayList(item); });
			if (index < 0) { return; }
			$('#playlist tr').eq(index).addClass('playing');
		});

		socket.on('requestPlayList', function(){
			updatePlayList();
		});

		$(function(){
			var loggedIn = $('.logged-in');
			var loggedOut = $('.logged-out');
			var loginDropdown = $('#login-dropdown');
			var loginForm = loginDropdown.find('form');
			var loginButton = loginForm.find('button[type=submit]');
			var loginError = loginForm.find('.text-error');

			loginForm.submit(function() {
				loginButton.button('loading');
				loginError.slideUp('fast');
				$(this).ajaxSubmit(function(res) {
					loginButton.button('reset');
					if (res.success) {
						loggedOut.fadeOut(null, function() {
							loggedIn.fadeIn();
						});
						loginDropdown.removeClass('open');
					} else {
						loginError.slideDown('fast');
					}
				});
				return false;
			});

			var register = $('#register');
			var registerForm = register.find('form');
			var registerButton = register.find('button[type=submit]');

			registerForm.submit(function() {
				registerButton.button('loading');
				$(this).ajaxSubmit(function(res) {
					registerButton.button('reset');
					if (res.success) {
						register.modal('hide');
						loggedOut.fadeOut(null, function() {
							loggedIn.fadeIn();
						});
					}
				});
				return false;
			});

			$('#logout').click(function() {
				$.ajax({ url: '/logout' }).done(function() {
					loggedIn.fadeOut(null, function() {
						loggedOut.fadeIn();
					});
				});
				return false;
			});

			$('#nickname').click(function() {
				var result = prompt('Enter a new nickname:');
				if (result) {
					socket.emit('nickname', result);
				}
			});

			$('#playlist').on('click', 'button.close', function () {
				$(this).closest('tr').remove();
				updatePlayList();
				return false;
			});

			$('#playlist').on('click', 'tr', function () {
				playEntry($(this));
			});

		});
	</script>
</body>
</html>
