<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>WristGrab Player</title>
	<link href="css/cyborg.min.css" rel="stylesheet" media="screen">
	<link href="style.css" rel="stylesheet" media="screen">
</head>
<body>
	<div class="navbar navbar-fixed-top">
		<div class="navbar-inner">
			<div class="container">
				<a class="brand" href="/">WristGrab</a>
				<ul class="nav">
					<li><a href="#">Browse Rooms <i class="icon-th-large"></i></a></li>
					<li><a href="#">Create Room <i class="icon-star"></i></a></li>
				</ul>
				<ul class="nav pull-right">
					<li id="login-dropdown" class="dropdown logged-out">
						<a class="dropdown-toggle" href="#" data-toggle="dropdown">Log In <i class="icon-share-alt"></i></a>
						<div class="dropdown-menu" style="padding: 15px;">
							<form method="post" action="/login">
								<input type="text" name="username" placeholder="Username or e-mail"></input>
								<input type="password" name="password" placeholder="Password"></input>
								<button type="submit" class="btn btn-block" data-loading-text="logging in..." autocomplete="off">Log in</button>
								<div class="text-error text-center" style="display: none;">Login failed!</div>
							</form>
						</div>
					</li>
					<li class="logged-out"><a href="#">Register <i class="icon-edit"></i></a></li>
					<li class="logged-in"><a href="#">Settings <i class="icon-cog"></i></a></li>
					<li class="logged-in"><a id="logout" href="#">Log Out <i class="icon-arrow-left"></i></a></li>
				</ul>
			</div>
		</div>
	</div>
	<div class="container">
		<div class="jumbotron text-center">
			<p class="lead">Watch videos together, no matter where you are. Add something to the playlist to get started.</p>
		</div>
		<div class="row-fluid">
			<div class="text-center">
				<!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
				<div id="player"></div>
			</div>
		</div>
		<div class="row-fluid">
				<div class="well">
					<ul id="chatbox" class="unstyled">
					</ul>
				</div>
				<form id="chatform" class="form-inline">
					<div class="input-append input-block-level" style="display: block;">
						<input id="chatinput" class="input-block-level" type="text" placeholder="Type a chat message..." autocomplete="off">
						<button id="chatbutton" class="btn" type="submit">Send <i class="icon-comment icon-white"></i></button>
					</div>
				</form>
		</div>
	</div>

	<script src="http://code.jquery.com/jquery.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script src="http://malsup.github.com/jquery.form.js"></script>
	<script>
		var socket = io.connect();

		// 2. This code loads the IFrame Player API code asynchronously.
		var tag = document.createElement('script');

		tag.src = 'https://www.youtube.com/iframe_api';
		var firstScriptTag = document.getElementsByTagName('script')[0];
		firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

		var width = $('#player').width();

		// 3. This function creates an <iframe> (and YouTube player)
		//    after the API code downloads.
		var player;
		function onYouTubeIframeAPIReady() {
			player = new YT.Player('player', {
				height: width * (9 / 16),
				width: width,
				videoId: 'U7mPqycQ0tQ',
				events: {
					'onReady': onPlayerReady,
					'onStateChange': onPlayerStateChange
				}
			});
		}

		// 4. The API will call this function when the video player is ready.
		function onPlayerReady(event) {
			//event.target.playVideo();
		}

		// 5. The API calls this function when the player's state changes.
		function onPlayerStateChange(event) {
			socket.emit('update', { 
				status : event.data, 
				time : player.getCurrentTime(), 
				loaded : player.getVideoLoadedFraction() 
			});
		}

		$('#chatform').submit(function() {
			var input = $('#chatinput');
			socket.emit('chat', { text: input.val() });
			input.val('');
			return false;
		});

		var updateChatButton = function(event) {
			if ($('#chatinput').val() == '') {
				$('#chatbutton').attr('disabled', 'disabled');
			} else {
				$('#chatbutton').removeAttr('disabled');
			}
		};

		updateChatButton();

		$('#chatinput').keyup(updateChatButton).keydown(updateChatButton).change(updateChatButton);

		socket.on('chat', function(data) {
			var div = $('#chatbox');
			div.append($('<li>').append($('<strong>').text(data.name + ': ')).append($('<span>').text(data.text)));
			div.animate({ scrollTop: div.prop('scrollHeight') - div.height() }, 1);
		});

		socket.on('pause', function(data) {
			player.seekTo(data.timestamp, true);
			player.pauseVideo();
		});

		socket.on('play', function(data) {
			player.seekTo(data.timestamp, true);
			player.playVideo();
		});

		$(function(){
			var loggedIn = $('.logged-in');
			var loggedOut = $('.logged-out');
			var loginDropdown = $('#login-dropdown');
			var loginForm = loginDropdown.find('form');
			var loginButton = loginForm.find('button[type=submit]');
			var loginError = loginForm.find('.text-error');

			loginForm.submit(function() {
				loginButton.button('loading');
				loginError.slideUp('fast');
				$(this).ajaxSubmit(function(res) {
					loginButton.button('reset');
					if (res.success) {
						loggedOut.fadeOut(null, function() {
							loggedIn.fadeIn();
						});
						loginDropdown.removeClass('open');
					} else {
						loginError.slideDown('fast');
					}
				});
				return false;
			});

			$('#logout').click(function() {
				$.ajax({ url: '/logout' }).done(function() {
					loggedIn.fadeOut(null, function() {
						loggedOut.fadeIn();
					});
				});
				return false;
			});
		});
	</script>
</body>
</html>
